---
title: "Case study 1: Effect of chemical exposures on preterm birth"
author: 
- name: Olivier Binette, Brian Kundinger and Joe Mathews
date: 'January 23, 2020'
abstract: "abstract..."
output: 
  pdf_document:
    keep_tex: true
    fig_caption: true
    latex_engine: pdflatex
    template: svm-latex-ms.tex
header-includes:
  - \usepackage{hyperref}
linestretch: 1.2
link-citations: yes
linkcolor: blue
geometry: margin=1in
fontfamily: mathpazo
fontsize: 11pt
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

library(tidyverse)
library(cowplot)
library(tableone)
library(BAS)
source("prettyplot.R")
```


# 1. Introduction



# 2. Materials and Methods

## 2.1 Data

Our analysis is based on the *Longnecker* dataset (Longnecker et al., 2001), which contains information on a subset of $2380$ pregnant women enrolled in the National Collaborative Perinatal Project (CCP). It relates gestational age to chemical exposures (*dde* and *pcb\_\** concentrations), to socio-economic variables (*maternal age*, *race*, *smoking status*, *center* of enrollment, and education, income and occupation *score\_\** variables), as well as to health-related variables (*cholesterol* and *triglycerides* concentrations).

Cleaning up the data, we removed the *albumin* variable, which contained $93\%$ missing values, and dropped observations of pregnancy over $55$ week. The single case with missing *pcb\_\** values was also removed. We are left with $n=2374$ observations and only missing values in the *score\_\** variables ($22\%$).  *Preterm* birth is defined as gestational age strictly less than 37 weeks ($n=361$; $15\%$), and *very preterm* is defined as gestational age strictly less than 34 weeks ($n=103$; $4\%$).

To facilitate data visualization and interpretation of the results, we grouped together the "black" ($n = 1220$) and "other" ($n = 123$) race categories into the single "non-white" category. For similar reasons, we summed together the $11$ positively correlated *pcb\_\** variables, obtaining the *totalpcb* variable. While this preserves units, important information may be lost through this process. Other supervised and unsupervised approaches to summarizing the *pcb\_\** variables are discussed in the appendix.

&nbsp;

#### Challenges and limitations.

Our scientific understanding of this data and of the data collection process is limited by a lack of documentation. It not possible to identify the represented population without knowledge of the enrollment mechanism, and therefore our observations may not generalize. Futhermore, it is unclear what should be taken as a scientifically meaningful predictor. Should *dde* be taken as a predictor or should it be normalized by lipid concentration? A meaningful predictor should strongly correlate with environmental exposure to DDT, and this is not something we can address through the data. Given these limitations and the fact that we have explored many models with the stated goal of identifying an interaction between *dde* and preterm birth risk, the results of our analysis should be taken as highly tentative and exploratory in nature.



Futhermore, there is a noticeable partial correlation between the *dde* and *totalpcb* variables ($\rho = 0.3$), after controlling for the linear effect of the other predictors (excluding *gestational\_age*). This could be the shadow of an unobserved confounding variable: unless *dde* and the *pcb\_\** are breakdown products of the same exposure, this hints at another factor contributing to higher chemical concentrations in the blood. This factor or other toxic chemicals could be causaly related to *gestational\_age*, and this prevents us from singling out any potentially causal effect.

```{r data transformation}
data = readRDS("Longnecker.rds") %>% 
  dplyr::select(-albumin) %>% 
  filter(gestational_age < 55) %>% 
  mutate(smoking_status = factor(ifelse(smoking_status, "smoking", "non-smoking")),
         preterm = gestational_age < 37,
         term_class = factor(case_when(gestational_age < 34 ~ "very_preterm",
                                       gestational_age < 37 ~ "late_preterm",
                                       TRUE ~ "non_preterm"), 
                             levels=c("very_preterm", "late_preterm", "non_preterm")),
         race = factor(ifelse(race=="white", "white", "other")),
         center = factor(center),
         n_col_NA = rowSums(cbind(is.na(score_education), 
                                  is.na(score_income), 
                                  is.na(score_occupation))),
         totalpcb = pcb_028 + pcb_052 + pcb_074 + pcb_105 + pcb_118 + pcb_153 + 
           pcb_170 + pcb_138 + pcb_180 +pcb_194 +pcb_203
         )

# Removing observation with NA PCBs
data = data[-1857, ]

# Remove NA values.
complete_data = data %>% filter(n_col_NA == 0)

data_i = read.csv("data_i.csv")
data_i = data_i %>% mutate(totalpcb=data$totalpcb)
```

```{r marginal effect plot, echo=FALSE, fig.width=6.5, fig.height=2, fig.cap="Marginal relationship between empirical preterm risk and chemical exposures. This does not take into account the effect of confounding variables; this is addressed in Section 2.3 (Models). The exposure ranges have been defined so that each class contains 25% of the observations and vertical lines represent 95% confidence intervals for the estimated risk."}
limits = c(-Inf, quantile(data$dde, c(0.25, 0.5, 0.75)), Inf)

prop_CI <- function(dat, level=0.95) {
  prop.test(sum(dat), length(dat), conf.level = level)$conf.int
}

p1 = data %>% 
  mutate(dde_range = cut(data$dde, limits)) %>% 
  group_by(dde_range, race) %>% 
  summarise(late_risk = mean(preterm),
            ymin = prop_CI(preterm)[1],
            ymax = prop_CI(preterm)[2]) %>% 
  ggplot(aes(x=dde_range, y=late_risk, color=race, group=race)) + 
  geom_line(position=position_dodge(0.2)) +
  geom_pointrange(aes(ymin=ymin, ymax=ymax), position=position_dodge(0.2)) +
  ylab("Empirical preterm risk") +
  xlab("dde exposure range") + 
  ylim(0,0.3) +
  theme_minimal() +
  theme(text = element_text(size=10), 
    legend.position="none",
    #legend.key.size = unit(0.6, "cm"),
    plot.title = element_text(hjust = 0)) +
  ggtitle("Preterm risk as a function of chemical exposures")


limits = c(-Inf, quantile(data$totalpcb, c(0.25, 0.5, 0.75)), Inf)

prop_CI <- function(dat, level=0.95) {
  prop.test(sum(dat), length(dat), conf.level = level)$conf.int
}

p2 = data %>% 
  mutate(PCB_range = cut(data$totalpcb, limits)) %>% 
  group_by(PCB_range, race) %>% 
  summarise(late_risk = mean(preterm),
            ymin = prop_CI(preterm)[1],
            ymax = prop_CI(preterm)[2]) %>% 
  ggplot(aes(x=PCB_range, y=late_risk, color=race, group=race)) + 
  geom_line(position=position_dodge(0.2)) +
  geom_pointrange(aes(ymin=ymin, ymax=ymax), position=position_dodge(0.2)) +
  ylab("") +
  xlab("totalpcb exposure range") +
  ylim(0,0.3) +
  theme_minimal() +
  theme(text = element_text(size=10), 
    legend.position="right",
    plot.title = element_text(hjust = 0)) +
  ggtitle(" ")


cowplot::plot_grid(p1, p2, rel_widths=c(1.1,1.5))
```

## 2.2 Missing Values Imputation

The $22\%$ missing values in the *score\_\** variables were imputed under a missing at random assumption using a standard Bayesian framework. We treated the score variables as independent, identically distributed Normal random variables and fitted a Bayesian linear model using the other predictor variables and a non-informative prior. That is, we regressed the observed values of the *score\_\** variables onto the other predictor variables and treat missing score values as model parameters, estimated through their posterior mean.

This approach has two major limitations. First, separating imputation from model fitting prevents the propagation of imputation uncertainty, although the Bayesian formulation would allow to combine the two steps together. Second, our approach assumes that observed variables in the data set can adequately predict the missing score values, or that data is missing at random. Even if this were to be the case, the data does not suggest clear linear relationships between the *score\_\** variables and other predictors. The potential of more complex non-linear models for the analysis of this dataset is considered in the Discussion section.

## 2.3 Logistic regression model for preterm outcome. 

We model the log odds ratio of preterm birth as a linear function of the other covariates and perform maximum likelihood estimation. This allows us to control for the baseline effect of the *race*, *smoking\_status* and *center* factors, and to control for the linear effect of socio-economic and health-related variables (*maternal\_age*, *score\_income*, *score\_education*, *score\_occupation*, *cholesterol*, and *triglycerides*) on the log odds ratio. Appart from *dde* and *totalpcb*, no other variables are incorporated into this base model, and no interaction terms are considered.

The importance of the *dde* and *totalpcb* variables is assessed by: (1) testing for individual and joint statistical significance of the variables; (2) by transforming the associated $p$-values to the more meaningful $B(p) = -e p \log(p)$ scale; and (3) by interpreting the estimated effect size. For part (1), individual statistical significance is based on standard approximate $t$-tests and joint significance is tested with an approximate $\chi^2$ test. The rationale for (2) is that $B(p)$ provides a lower bound on the Bayes factor comparing the null hypothesis of no effect to the alternative (over a large nonparametric class of reasonable prior distributions). For example, a $p$-value of $0.01$ is transformed to $B(0.01) \approx 1/8$: if both the null and the alternative hypotheses are a priori equally likely, then a posteriori the alternative hypothesis cannot be more than 8 times more likely than the null. Our interpretation (3) relies on the multiplicative contribution of the *dde* and *pcb* coefficients on the odds ratio of preterm birth, as a function of the empirical quantiles of exposure.

```{r, echo=FALSE, include=FALSE, message=FALSE}
model.base <- glm(preterm ~ -1 + race + smoking_status + center + 
                    maternal_age + triglycerides + cholesterol +
                    score_income + score_education + score_occupation +
                    dde + totalpcb, 
                  family="binomial", data=data_i)
summary(model.base)

model.base.nochems <- glm(preterm ~ -1 + race + smoking_status + center + 
                        maternal_age + triglycerides + cholesterol +
                        score_income + score_education + score_occupation, 
                      family="binomial", data=data_i)

anova(model.base, model.base.nochems, test="Chisq")
```

# 3. Results

```{r, echo=FALSE, include=FALSE}
dde_est = c(coef(model.base)["dde"], confint(model.base)["dde",])
pcb_est = c(coef(model.base)["totalpcb"], confint(model.base)["totalpcb",])

dde_effect <- Vectorize(function(q) {
  c(exp(dde_est[1]*quantile(data$dde, q)),
    exp(dde_est[2]*quantile(data$dde, q)),
    exp(dde_est[3]*quantile(data$dde, q)))
})

pcb_effect <- Vectorize(function(q) {
  c(exp(pcb_est[1]*quantile(data$totalpcb, q)),
    exp(pcb_est[2]*quantile(data$totalpcb, q)),
    exp(pcb_est[3]*quantile(data$totalpcb, q)))
})


q = seq(0,0.99,length.out = 400)
dde_curve = dde_effect(q)
pcb_curve = pcb_effect(q)
```


```{r, echo=FALSE, results='asis'}
cat("
|               | *dde*         | *totalpcb*  | jointly                     |
|--------------:|:-------------:|:-----------:|:---------------------------:|
| $p$-value     | 0.0032        | 0.023       |   0.00014                   |
| $B(p)$        |     1/20      |  1/4.2      | 1/290                       |
")
```

```{r, echo=FALSE, fig.width=4, fig.height=2.2, fig.align="center"}
par(mar=c(3,3,1,1))
plot(q, pcb_curve[1,], type="l", lwd=2, col=2,
      xlab="Exposure quantile",
     ylab="Multiplicative effect")
polygon(c(q, rev(q)), c(pcb_curve[2,], rev(pcb_curve[3,])), border=NA, 
        col=adjustcolor(cmap.knitr(2), alpha.f=0.2))

lines(q, dde_curve[1,], type="l", lwd=2)
polygon(c(q, rev(q)), c(dde_curve[2,], rev(dde_curve[3,])), border=NA, 
        col=adjustcolor(cmap.knitr(1), alpha.f=0.2))

legend("topleft", c("dde", "pcb"), col=c(cmap.knitr(1), cmap.knitr(2)), lty=1, cex=0.8)
```


# 4. Discussion







